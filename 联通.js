// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: red; icon-glyph: mobile-alt;
/**
* Author:LSP
* Date:2023-02-13
*/
// -------------------------------------------------------
// ÊòØÂê¶ÊòØÂºÄÂèëÁéØÂ¢ÉÔºåÈÖçÂêàÊâãÊú∫Á´ØË∞ÉËØï‰ΩøÁî®ÔºåÊ≠£ÂºèÂèëÂ∏ÉËÆæÁΩÆ‰∏∫false
const isDev = false;
const dependencyLSP = '20230204';
console.log(`ÂºÄÂèëÁéØÂ¢É üëâüëâüëâüëâüëâ ${isDev ? 'DEV' : 'RELEASE'}`);
console.log(`----------------------------------------`);
// ÂàÜÊîØ
const branch = 'master';
// ‰ªìÂ∫ìÊ†πÁõÆÂΩï
const remoteRoot = `https://gitcode.net/enoyee/scriptable/-/raw/${branch}`;
// ‰æùËµñÂåÖÁõÆÂΩï
const fm = FileManager.local();
const rootDir = fm.documentsDirectory();
const cacheDir = fm.joinPath(rootDir, 'LSP');
const dependencyFileName = isDev ? "_LSP.js" : `${cacheDir}/_LSP.js`;
// ‰∏ãËΩΩ‰æùËµñÂåÖ
await downloadLSPDependency();
// -------------------------------------------------------
if (typeof require === 'undefined') require = importModule
// ÂºïÂÖ•Áõ∏ÂÖ≥ÊñπÊ≥ï
const { BaseWidget } = require(dependencyFileName);

// @ÂÆö‰πâÂ∞èÁªÑ‰ª∂
class Widget extends BaseWidget {

  defaultPreference = {
    fetchUrl: {
      detail: `https://m.client.10010.com/mobileserviceimportant/home/queryUserInfoSeven?version=iphone_c@10.0100&desmobiel=13232135179&showType=0`,
    },
    titleDayColor: '#000000',
    titleNightColor: '#000000',
    descDayColor: '#000000',
    descNightColor: '#000000',
    refreshTimeDayColor: '#000000',
    refreshTimeNightColor: '#000000',
  };

  fee = {
    title: 'üì± Ââ©‰ΩôËØùË¥πÔºö',
    balance: 0,
    unit: 'ÂÖÉ',
  };

  voice = {
    title: '‚è≥ Ââ©‰ΩôËØ≠Èü≥Ôºö',
    balance: 0,
    percent: 0,
    unit: 'ÂàÜÈíü',
  };

  flow = {
    title: '‚õΩÔ∏è Ââ©‰ΩôÊµÅÈáèÔºö',
    balance: 0,
    percent: 0,
    unit: 'MB',
  };

  getValueByKey = (key) => this.readWidgetSetting()[key] ?? '';

  titleDayColor = () => this.getValueByKey('titleDayColor');
  titleNightColor = () => this.getValueByKey('titleNightColor');

  descDayColor = () => this.getValueByKey('descDayColor');
  descNightColor = () => this.getValueByKey('descNightColor');

  refreshTimeDayColor = () => this.getValueByKey('refreshTimeDayColor');
  refreshTimeNightColor = () => this.getValueByKey('refreshTimeNightColor');

  constructor(scriptName) {
    super(scriptName);
    this.reset = false;
    this.defaultConfig.bgType = '3';
    this.backgroundColor = '#FEFCF3,#0A2647';
    this.cookie = this.getValueByKey('cookie');
  }

  async getAppViewOptions() {
    return {
      widgetProvider: {
        small: true, // ÊòØÂê¶Êèê‰æõÂ∞èÂè∑ÁªÑ‰ª∂
        medium: false, // ÊòØÂê¶Êèê‰æõ‰∏≠Âè∑ÁªÑ‰ª∂
        large: false, // ÊòØÂê¶Êèê‰æõÂ§ßÂè∑ÁªÑ‰ª∂
      },
      // È¢ÑËßàÁïåÈù¢ÁöÑÁªÑ‰ª∂ËÆæÁΩÆitem
      settingItems: [
        {
          name: 'chinaUnicomCK',
          label: 'ËÅîÈÄöCookie',
          type: 'cell',
          icon: `${remoteRoot}/img/icon_10010.png`,
          needLoading: true,
          desc: this.getValueByKey('cookie')?.length > 0 ? 'Â∑≤Â°´ÂÜô' : 'Êú™Â°´ÂÜô'
        },
        {
          name: 'otherSetting',
          label: 'ÂÖ∂‰ªñËÆæÁΩÆ',
          type: 'cell',
          icon: `${remoteRoot}/img/setting.gif`,
          needLoading: true,
          childItems: [
            {
              items: [
                {
                  name: 'titleDayColor',
                  label: 'Ê†áÈ¢òÊµÖËâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'pencil.and.outline', color: '#3a86ff', },
                  needLoading: false,
                  default: this.titleDayColor(),
                },
                {
                  name: 'titleNightColor',
                  label: 'Ê†áÈ¢òÊ∑±Ëâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'square.and.pencil', color: '#3a0ca3', },
                  needLoading: false,
                  default: this.titleNightColor(),
                },
              ],
            },
            {
              items: [
                {
                  name: 'descDayColor',
                  label: 'ÂÜÖÂÆπÊµÖËâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'pencil.and.outline', color: '#3a86ff', },
                  needLoading: false,
                  default: this.descDayColor(),
                },
                {
                  name: 'descNightColor',
                  label: 'ÂÜÖÂÆπÊ∑±Ëâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'square.and.pencil', color: '#3a0ca3', },
                  needLoading: false,
                  default: this.descNightColor(),
                },
              ],
            },
            {
              items: [
                {
                  name: 'refreshTimeDayColor',
                  label: 'Âà∑Êñ∞Êó∂Èó¥ÊµÖËâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'pencil.and.outline', color: '#3a86ff', },
                  needLoading: false,
                  default: this.refreshTimeDayColor(),
                },
                {
                  name: 'refreshTimeNightColor',
                  label: 'Âà∑Êñ∞Êó∂Èó¥Ê∑±Ëâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'square.and.pencil', color: '#3a0ca3', },
                  needLoading: false,
                  default: this.refreshTimeNightColor(),
                },
              ],
            },
          ]
        },
      ],
      // cellÁ±ªÂûãÁöÑitemÁÇπÂáªÂõûË∞É
      onItemClick: async (item) => {
        const widgetSetting = this.readWidgetSetting();
        let insertDesc = widgetSetting.phone?.length > 0 && widgetSetting.cookie?.length > 0 ? 'Â∑≤Â°´ÂÜô' : 'Êú™Â°´ÂÜô';
        switch (item.name) {
          case 'chinaUnicomCK':
            let phone;
            let ck;
            await this.generateInputAlert({
              title: 'ÁôªÂΩï‰ø°ÊÅØÂ°´ÂÜô',
              message: 'Ëá™Â∑±ÊäìÂèñËÅîÈÄöÂÆ¢Êà∑Á´ØappÁöÑcookieÂ°´ÂÖ•',
              options: [
                { hint: 'ËØ∑ËæìÂÖ•ËÅîÈÄöÂè∑Á†Å', value: widgetSetting?.phone ?? '' },
                { hint: 'ËØ∑ËæìÂÖ•cookie', value: widgetSetting?.cookie ?? '' },
              ]
            }, async (inputArr) => {
              this.reset = true;
              phone = inputArr[0].value;
              ck = inputArr[1].value;
              // ‰øùÂ≠òÈÖçÁΩÆ
              widgetSetting['phone'] = phone;
              widgetSetting['cookie'] = ck;
            });
            this.cookie = widgetSetting.cookie;
            insertDesc = phone?.length > 0 && ck?.length > 0 ? 'Â∑≤Â°´ÂÜô' : 'Êú™Â°´ÂÜô';
            this.writeWidgetSetting({ ...widgetSetting });
            break;
        }
        return {
          desc: { value: insertDesc },
        };
      },
    };
  }

  async render() {
    return await this.provideSmallWidget();
  }

  async provideSmallWidget() {
    // ========================================
    await this.loadDetailInfo();
    const voiceBalance = this.voice.balance;
    // ========================================
    const widget = new ListWidget();
    widget.setPadding(0, 0, 0, 0);
    // ========================================
    const widgetSize = this.getWidgetSize('Â∞èÂè∑');
    let stack = widget.addStack();
    let image = await this.getImageByUrl(`${remoteRoot}/img/bg_doraemon_1.png`);
    stack.setPadding(4, 12, 0, 12);
    stack.backgroundImage = image;
    stack.size = new Size(widgetSize.width, widgetSize.height);
    stack.layoutVertically();
    stack.addSpacer();
    // ========================================
    const titleFont = Font.lightSystemFont(13);
    const infoFont = Font.mediumSystemFont(16);
    const titleTextColor = Color.dynamic(new Color(this.titleDayColor()), new Color(this.titleNightColor()));
    const descTextColor = Color.dynamic(new Color(this.descDayColor()), new Color(this.descNightColor()));
    const refreshTimeTextColor = Color.dynamic(new Color(this.refreshTimeDayColor()), new Color(this.refreshTimeNightColor()));
    const descSpacer = 3;
    const lineSpacer = 4;
    const descLeftSpacer = 22;
    // ========================================
    let textSpan = stack.addText(`${this.fee.title}`);
    textSpan.textColor = titleTextColor
    textSpan.font = titleFont;
    // 
    stack.addSpacer(descSpacer);
    let displayStack = stack.addStack();
    displayStack.centerAlignContent();
    displayStack.addSpacer(descLeftSpacer);
    textSpan = displayStack.addText(`${this.fee.balance}${this.fee.unit}`);
    textSpan.textColor = descTextColor
    textSpan.font = infoFont
    displayStack.addSpacer();
    // ========================================
    stack.addSpacer(lineSpacer);
    textSpan = stack.addText(`${this.voice.title}`);
    textSpan.textColor = titleTextColor
    textSpan.font = titleFont;
    // 
    stack.addSpacer(descSpacer);
    displayStack = stack.addStack();
    displayStack.centerAlignContent();
    displayStack.addSpacer(descLeftSpacer);
    textSpan = displayStack.addText(`${voiceBalance}${this.voice.unit}`);
    textSpan.textColor = descTextColor
    textSpan.font = infoFont
    displayStack.addSpacer();
    // ========================================
    stack.addSpacer(lineSpacer);
    textSpan = stack.addText(`${this.flow.title}`);
    textSpan.textColor = titleTextColor
    textSpan.font = titleFont;
    // 
    stack.addSpacer(descSpacer);
    displayStack = stack.addStack();
    displayStack.centerAlignContent();
    displayStack.addSpacer(descLeftSpacer);
    textSpan = displayStack.addText(`${this.flow.balance}${this.flow.unit}`);
    textSpan.textColor = descTextColor
    textSpan.font = infoFont
    displayStack.addSpacer();
    // ========================================

    // ========================================
    stack.addSpacer(6);
    let btStack = stack.addStack();
    btStack.centerAlignContent();
    btStack.addSpacer(6);
    image = this.getSFSymbol('goforward');
    let imgSpan = btStack.addImage(image);
    imgSpan.imageSize = new Size(9, 9);
    imgSpan.tintColor = refreshTimeTextColor
    btStack.addSpacer(4);
    if (this.success) {
      this.lastUpdate = this.getDateStr(new Date(), 'HH:mm');
    }
    textSpan = btStack.addText(`${this.getDateStr(new Date(), 'HH:mm')}`);
    textSpan.textColor = refreshTimeTextColor
    textSpan.font = Font.lightSystemFont(10);
    btStack.addSpacer();
    image = await this.getImageByUrl(`${remoteRoot}/img/ic_logo_10010.png`);
    imgSpan = btStack.addImage(image);
    imgSpan.imageSize = new Size(14, 14);
    stack.addSpacer();
    //=================================
    return widget;
  }

  // --------------------------NET START--------------------------
  /**
   * ÊµÅÈáèÊ†ºÂºèÂåñ
   * @param {*} flow 
   * @returns 
   */
  formatFlow = (flow) => {
    const remain = flow / 1024;
    if (remain < 1024) {
      return { amount: remain.toFixed(2), unit: 'MB' };
    }
    return { amount: (remain / 1024).toFixed(2), unit: 'GB' };
  }

  /**
   * Âä†ËΩΩÊòéÁªÜ
   * @returns 
   */
  loadDetailInfo = async () => {
    const response = await this.httpGet(
      this.defaultPreference.fetchUrl.detail,
      {
        useCache: this.reset ?? false,
        dataSuccess: (res) => res.code == 'Y',
        headers: {
          'Host': 'm.client.10010.com',
          'User-Agent': 'ChinaUnicom.x CFNetwork iOS/16.3 unicom{version:iphone_c@10.0100}',
          'cookie': this.cookie,
        }
      }
    );
    if (response?.code == 'Y') {
      const { feeResource, voiceResource, flowResource } = response;
      // ËØùË¥π
      this.fee = {
        title: `üì± ${feeResource?.dynamicFeeTitle}Ôºö`,
        balance: feeResource?.feePersent,
        unit: feeResource?.newUnit,
      };
      // ËØ≠Èü≥
      this.voice = {
        title: `‚è≥ ${voiceResource?.dynamicVoiceTitle}Ôºö`,
        balance: voiceResource?.voicePersent,
        percent: 0,
        unit: voiceResource?.newUnit,
      };
      // ÊµÅÈáè
      this.flow = {
        title: `‚õΩÔ∏è ${flowResource?.dynamicFlowTitle}Ôºö`,
        balance: flowResource?.flowPersent,
        percent: 0,
        unit: flowResource?.newUnit,
      };
      console.log(`ËØùË¥πÔºö`);
      console.log(JSON.stringify(this.fee, null, 2));
      console.log(`ËØ≠Èü≥Ôºö`);
      console.log(JSON.stringify(this.voice, null, 2));
      console.log(`ÊµÅÈáèÔºö`);
      console.log(JSON.stringify(this.flow, null, 2));
    } else {
      this.notify('ËÅîÈÄöÂ∞èÁªÑ‰ª∂', `ÂèØËÉΩcookieÂ§±Êïà‰∫Ü~`);
    }
  }

  // --------------------------NET END--------------------------
}

await new Widget(Script.name()).run();


// =================================================================================
// =================================================================================
async function downloadLSPDependency() {
  let fm = FileManager.local();
  const dependencyURL = `${remoteRoot}/_LSP.js`;
  const update = needUpdateDependency();
  if (isDev) {
    const iCloudPath = FileManager.iCloud().documentsDirectory();
    const localIcloudDependencyExit = fm.isFileStoredIniCloud(`${iCloudPath}/_LSP.js`);
    const localDependencyExit = fm.fileExists(`${rootDir}/_LSP.js`);
    const fileExist = localIcloudDependencyExit || localDependencyExit;
    console.log(`üöÄ DEVÂºÄÂèë‰æùËµñÊñá‰ª∂${fileExist ? 'Â∑≤Â≠òÂú® ‚úÖ' : '‰∏çÂ≠òÂú® üö´'}`);
    if (!fileExist || update) {
      console.log(`ü§ñ DEV ÂºÄÂßã${update ? 'Êõ¥Êñ∞' + dependencyLSP : '‰∏ãËΩΩ'}‰æùËµñ~`);
      keySave('VERSION', dependencyLSP);
      await downloadFile2Scriptable('_LSP', dependencyURL);
    }
    return
  }

  //////////////////////////////////////////////////////////
  console.log(`----------------------------------------`);
  const remoteDependencyExit = fm.fileExists(`${cacheDir}/_LSP.js`);
  console.log(`üöÄ RELEASE‰æùËµñÊñá‰ª∂${remoteDependencyExit ? 'Â∑≤Â≠òÂú® ‚úÖ' : '‰∏çÂ≠òÂú® üö´'}`);
  // ------------------------------
  if (!remoteDependencyExit || update) { // ‰∏ãËΩΩ‰æùËµñ
    // ÂàõÂª∫Ê†πÁõÆÂΩï
    if (!fm.fileExists(cacheDir)) {
      fm.createDirectory(cacheDir, true);
    }
    // ‰∏ãËΩΩ
    console.log(`ü§ñ RELEASEÂºÄÂßã${update ? 'Êõ¥Êñ∞' : '‰∏ãËΩΩ'}‰æùËµñ~`);
    console.log(`----------------------------------------`);
    const req = new Request(dependencyURL);
    const moduleJs = await req.load();
    if (moduleJs) {
      fm.write(fm.joinPath(cacheDir, '/_LSP.js'), moduleJs);
      keySave('VERSION', dependencyLSP);
      console.log('‚úÖ LSPËøúÁ®ã‰æùËµñÁéØÂ¢É‰∏ãËΩΩÊàêÂäüÔºÅ');
      console.log(`----------------------------------------`);
    } else {
      console.error('üö´ Ëé∑Âèñ‰æùËµñÁéØÂ¢ÉËÑöÊú¨Â§±Ë¥•ÔºåËØ∑ÈáçËØïÔºÅ');
      console.log(`----------------------------------------`);
    }
  }
}

/**
 * Ëé∑Âèñ‰øùÂ≠òÁöÑÊñá‰ª∂Âêç
 * @param {*} fileName 
 * @returns 
 */
function getSaveFileName(fileName) {
  const hasSuffix = fileName.lastIndexOf(".") + 1;
  return !hasSuffix ? `${fileName}.js` : fileName;
};

/**
 * ‰øùÂ≠òÊñá‰ª∂Âà∞ScriptableËΩØ‰ª∂ÁõÆÂΩïÔºåappÂèØÁúãÂà∞
 * @param {*} fileName 
 * @param {*} content 
 * @returns 
 */
function saveFile2Scriptable(fileName, content) {
  try {
    const fm = FileManager.iCloud();
    let fileSimpleName = getSaveFileName(fileName);
    const filePath = fm.joinPath(fm.documentsDirectory(), fileSimpleName);
    fm.writeString(filePath, content);
    return true;
  } catch (error) {
    return false;
  }
};

/**
 * ‰∏ãËΩΩjsÊñá‰ª∂Âà∞ScriptableËΩØ‰ª∂ÁõÆÂΩï
 * @param {*} moduleName ÂêçÁß∞ 
 * @param {*} url Âú®Á∫øÂú∞ÂùÄ 
 * @returns 
 */
async function downloadFile2Scriptable(moduleName, url) {
  const req = new Request(url);
  const content = await req.loadString();
  return saveFile2Scriptable(`${moduleName}`, content);
};

/**
 * ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞‰æùËµñÁâàÊú¨
 */
function needUpdateDependency() {
  return dependencyLSP != keyGet('VERSION');
};

function keySave(cacheKey, cache) {
  if (cache) {
    Keychain.set(Script.name() + cacheKey, cache);
  }
}

function keyGet(cacheKey, defaultValue = '') {
  if (Keychain.contains(Script.name() + cacheKey)) {
    return Keychain.get(Script.name() + cacheKey);
  } else {
    return defaultValue;
  }
}
// =================================================================================
// =================================================================================