// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: blue; icon-glyph: mobile-alt;
/**
 * Author:LSP
 * Date:2024-03-15
 */
// -------------------------------------------------------
// ÊòØÂê¶ÊòØÂºÄÂèëÁéØÂ¢ÉÔºåÈÖçÂêàÊâãÊú∫Á´ØË∞ÉËØï‰ΩøÁî®ÔºåÊ≠£ÂºèÂèëÂ∏ÉËÆæÁΩÆ‰∏∫false
const isDev = false;
const dependencyLSP = '20230512';
console.log(`ÂΩìÂâçÁéØÂ¢É üëâüëâüëâüëâüëâ ${isDev ? 'DEV' : 'RELEASE'}`);
console.log(`----------------------------------------`);
// ÂàÜÊîØ
const branch = 'v2';
// ‰ªìÂ∫ìÊ†πÁõÆÂΩï
const remoteGithubRoot = `https://raw.githubusercontent.com/Enjoyee/Scriptable/${branch}`;
const remoteHomeLandRoot = `https://glimmerk.coding.net/p/Scriptable/shared-depot/source/git/raw/${branch}`;
// ‰æùËµñÂåÖÁõÆÂΩï
const fm = FileManager.local();
const rootDir = fm.documentsDirectory();
const cacheDir = fm.joinPath(rootDir, 'LSP');
const dependencyFileName = isDev ? "_LSP.js" : `${cacheDir}/_LSP.js`;
// ‰∏ãËΩΩ‰æùËµñÂåÖ
await downloadLSPDependency();
// -------------------------------------------------------
if (typeof require === 'undefined') require = importModule
// ÂºïÂÖ•Áõ∏ÂÖ≥ÊñπÊ≥ï
const { BaseWidget } = require(dependencyFileName);

// @ÂÆö‰πâÂ∞èÁªÑ‰ª∂
class Widget extends BaseWidget {

  defaultPreference = {
    cache_key_detail: 'detail',
    cache_key_balance: 'balance',
    fetchUrl: {
      home: 'https://e.189.cn/store/wap/partner/stylehead/189Bill.do',
      detail: 'https://e.189.cn/store/user/package_detail.do?t=189Bill',
      balance: 'https://e.189.cn/store/user/balance_new.do',
    },
    titleDayColor: '#000000',
    titleNightColor: '#000000',
    descDayColor: '#000000',
    descNightColor: '#000000',
    refreshTimeDayColor: '#000000',
    refreshTimeNightColor: '#000000',
  };

  fee = {
    title: 'üì± Ââ©‰ΩôËØùË¥πÔºö',
    balance: 0,
    unit: 'ÂÖÉ',
  };

  voice = {
    title: '‚è≥ Ââ©‰ΩôËØ≠Èü≥Ôºö',
    balance: 0,
    percent: 0,
    unit: 'ÂàÜÈíü',
  };

  flow = {
    title: '‚õΩÔ∏è Ââ©‰ΩôÊµÅÈáèÔºö',
    balance: 0,
    percent: 0,
    unit: 'MB',
  };

  getValueByKey = (key) => this.readWidgetSetting()[key] ?? '';

  titleDayColor = () => this.getValueByKey('titleDayColor');
  titleNightColor = () => this.getValueByKey('titleNightColor');

  descDayColor = () => this.getValueByKey('descDayColor');
  descNightColor = () => this.getValueByKey('descNightColor');

  refreshTimeDayColor = () => this.getValueByKey('refreshTimeDayColor');
  refreshTimeNightColor = () => this.getValueByKey('refreshTimeNightColor');

  constructor(scriptName) {
    super(scriptName);
    this.reset = false;
    this.defaultConfig.bgType = '3';
    this.backgroundColor = '#FEFCF3,#0A2647';
    this.cookie = this.getValueByKey('cookie');
  }

  async getAppViewOptions() {
    return {
      widgetProvider: {
        small: true, // ÊòØÂê¶Êèê‰æõÂ∞èÂè∑ÁªÑ‰ª∂
        medium: false, // ÊòØÂê¶Êèê‰æõ‰∏≠Âè∑ÁªÑ‰ª∂
        large: false, // ÊòØÂê¶Êèê‰æõÂ§ßÂè∑ÁªÑ‰ª∂
      },
      // È¢ÑËßàÁïåÈù¢ÁöÑÁªÑ‰ª∂ËÆæÁΩÆitem
      settingItems: [
        {
          name: 'chinaTelecomCK',
          label: 'Â§©Áøº‰ø°ÊÅØ',
          type: 'cell',
          icon: `${this.getRemoteRootPath()}/img/icon_10000.png`,
          needLoading: true,
          desc: this.getValueByKey('cookie')?.length > 0 ? 'Â∑≤ÁôªÂΩï' : 'Êú™ÁôªÂΩï'
        },
        {
          name: 'filterOrientateFlow',
          label: 'ËøáÊª§ÂÆöÂêëÊµÅÈáè',
          type: 'switch',
          icon: { name: 'bag.fill', color: '#F14A16', },
          needLoading: false,
          default: false
        },
        {
          name: 'showUsedFlow',
          label: 'ÊòæÁ§∫Â∑≤‰ΩøÁî®ÊµÅÈáè',
          type: 'switch',
          icon: { name: 'archivebox.fill', color: '#ECA97A', },
          needLoading: false,
          default: false
        },
        {
          name: 'otherSetting',
          label: 'ÂÖ∂‰ªñËÆæÁΩÆ',
          type: 'cell',
          icon: 'https://cdnjson.com/images/2024/02/05/settings.png',
          needLoading: true,
          childItems: [
            {
              items: [
                {
                  name: 'titleDayColor',
                  label: 'Ê†áÈ¢òÊµÖËâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'pencil.and.outline', color: '#3a86ff', },
                  needLoading: false,
                  default: this.titleDayColor(),
                },
                {
                  name: 'titleNightColor',
                  label: 'Ê†áÈ¢òÊ∑±Ëâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'square.and.pencil', color: '#3a0ca3', },
                  needLoading: false,
                  default: this.titleNightColor(),
                },
              ],
            },
            {
              items: [
                {
                  name: 'descDayColor',
                  label: 'ÂÜÖÂÆπÊµÖËâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'pencil.and.outline', color: '#3a86ff', },
                  needLoading: false,
                  default: this.descDayColor(),
                },
                {
                  name: 'descNightColor',
                  label: 'ÂÜÖÂÆπÊ∑±Ëâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'square.and.pencil', color: '#3a0ca3', },
                  needLoading: false,
                  default: this.descNightColor(),
                },
              ],
            },
            {
              items: [
                {
                  name: 'refreshTimeDayColor',
                  label: 'Âà∑Êñ∞Êó∂Èó¥ÊµÖËâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'pencil.and.outline', color: '#3a86ff', },
                  needLoading: false,
                  default: this.refreshTimeDayColor(),
                },
                {
                  name: 'refreshTimeNightColor',
                  label: 'Âà∑Êñ∞Êó∂Èó¥Ê∑±Ëâ≤È¢úËâ≤',
                  type: 'color',
                  icon: { name: 'square.and.pencil', color: '#3a0ca3', },
                  needLoading: false,
                  default: this.refreshTimeNightColor(),
                },
              ],
            },
          ]
        },
      ],
      // cellÁ±ªÂûãÁöÑitemÁÇπÂáªÂõûË∞É
      onItemClick: async (item) => {
        let insertDesc;
        const widgetSetting = this.readWidgetSetting();
        switch (item.name) {
          case 'chinaTelecomCK':
            let ck;
            let selectIndex = await this.generateAlert('ÁôªÂΩï‰ø°ÊÅØ', '1.ÁΩëÈ°µÁôªÂΩï\n2.Ëá™Â∑±ÊäìÂèñÂ°´ÂÖ•ck', ['ÁΩëÈ°µÁôªÂΩï', 'Áõ¥Êé•Â°´ÂÖ•']);
            if (selectIndex == 0) {
              const webview = new WebView();
              await webview.loadURL(this.defaultPreference.fetchUrl.home);
              await webview.present();
              const request = new Request(this.defaultPreference.fetchUrl.balance);
              request.method = 'POST';
              request.credentials = 'include';
              const response = await request.loadJSON();
              console.log(
                JSON.stringify(response, null, 2)
              );
              if (response?.result == 0) {
                const cookies = request.response.cookies;
                let cookie = [];
                cookie = cookies.map((item) => item.name + '=' + item.value);
                ck = cookie.join('; ');
                // ‰øùÂ≠òÈÖçÁΩÆ
                widgetSetting['cookie'] = ck;
              }
            } else {
              Pasteboard.copy(this.defaultPreference.fetchUrl.home);
              await this.generateInputAlert({
                title: 'ÁôªÂΩï‰ø°ÊÅØÂ°´ÂÜô',
                message: 'Â°´ÂÖ•ÊäìÂèñÂ§©ÁøºÁöÑcookie\nüëâÁôªÂΩïÂú∞ÂùÄÂ∑≤Â§çÂà∂Âà∞Á≤òË¥¥Êùø‰∫Üüëà',
                options: [
                  { hint: 'ËØ∑ËæìÂÖ•cookie', value: widgetSetting?.cookie ?? '' },
                ]
              }, async (inputArr) => {
                this.reset = true;
                ck = inputArr[0].value;
                // ‰øùÂ≠òÈÖçÁΩÆ
                widgetSetting['cookie'] = ck;
              });
            }
            this.cookie = widgetSetting.cookie;
            insertDesc = ck?.length > 0 ? 'Â∑≤Â°´ÂÜô' : 'Êú™Â°´ÂÜô';
            this.writeWidgetSetting({ ...widgetSetting });
            break;
        }
        return {
          desc: { value: insertDesc },
        };
      },
    };
  }

  async render({ widgetSetting }) {
    return await this.provideSmallWidget(widgetSetting);
  }

  async provideSmallWidget(widgetSetting) {
    // ========================================
    await this.loadMoneyBalance();
    await this.loadDetailInfo(widgetSetting);
    const voiceBalance = this.voice.balance;
    // ========================================
    const widget = new ListWidget();
    widget.setPadding(0, 0, 0, 0);
    // ========================================
    const widgetSize = this.getWidgetSize('Â∞èÂè∑');
    let stack = widget.addStack();
    let image = await this.getImageByUrl(`${this.getRemoteRootPath()}/img/bg_doraemon_1.png`);
    stack.setPadding(4, 12, 0, 12);
    stack.backgroundImage = image;
    stack.size = new Size(widgetSize.width, widgetSize.height);
    stack.layoutVertically();
    stack.addSpacer();
    // ========================================
    const titleFont = Font.lightSystemFont(13);
    const infoFont = Font.mediumSystemFont(16);
    const titleTextColor = Color.dynamic(new Color(this.titleDayColor()), new Color(this.titleNightColor()));
    const descTextColor = Color.dynamic(new Color(this.descDayColor()), new Color(this.descNightColor()));
    const refreshTimeTextColor = Color.dynamic(new Color(this.refreshTimeDayColor()), new Color(this.refreshTimeNightColor()));
    const descSpacer = 3;
    const lineSpacer = 4;
    const descLeftSpacer = 22;
    // ========================================
    let textSpan = stack.addText(`${this.fee.title}`);
    textSpan.textColor = titleTextColor;
    textSpan.font = titleFont;
    // 
    stack.addSpacer(descSpacer);
    let displayStack = stack.addStack();
    displayStack.centerAlignContent();
    displayStack.addSpacer(descLeftSpacer);
    textSpan = displayStack.addText(`${this.fee.balance}${this.fee.unit}`);
    textSpan.textColor = descTextColor;
    textSpan.font = infoFont;
    displayStack.addSpacer();
    // ========================================
    stack.addSpacer(lineSpacer);
    textSpan = stack.addText(`${this.voice.title} `);
    textSpan.textColor = titleTextColor;
    textSpan.font = titleFont;
    // 
    stack.addSpacer(descSpacer);
    displayStack = stack.addStack();
    displayStack.centerAlignContent();
    displayStack.addSpacer(descLeftSpacer);
    textSpan = displayStack.addText(`${voiceBalance}${this.voice.unit}`);
    textSpan.textColor = descTextColor;
    textSpan.font = infoFont;
    displayStack.addSpacer();
    // ========================================
    stack.addSpacer(lineSpacer);
    textSpan = stack.addText(`${this.flow.title} `);
    textSpan.textColor = titleTextColor;
    textSpan.font = titleFont;
    // 
    stack.addSpacer(descSpacer);
    displayStack = stack.addStack();
    displayStack.centerAlignContent();
    displayStack.addSpacer(descLeftSpacer);
    textSpan = displayStack.addText(`${this.flow.balance}${this.flow.unit}`);
    textSpan.textColor = descTextColor;
    textSpan.font = infoFont;
    displayStack.addSpacer();
    // ========================================

    // ========================================
    stack.addSpacer(6);
    let btStack = stack.addStack();
    btStack.centerAlignContent();
    btStack.addSpacer(6);
    image = this.getSFSymbol('goforward');
    let imgSpan = btStack.addImage(image);
    imgSpan.imageSize = new Size(9, 9);
    imgSpan.tintColor = refreshTimeTextColor;
    btStack.addSpacer(4);
    if (this.success) {
      this.lastUpdate = this.getDateStr(new Date(), 'HH:mm');
    }
    textSpan = btStack.addText(`${this.getDateStr(new Date(), 'HH:mm')} `);
    textSpan.textColor = refreshTimeTextColor;
    textSpan.font = Font.lightSystemFont(10);
    btStack.addSpacer();
    image = await this.getImageByUrl(`${this.getRemoteRootPath()}/img/ic_logo_10000.jpg`);
    imgSpan = btStack.addImage(image);
    imgSpan.imageSize = new Size(14, 14);
    stack.addSpacer();
    //=================================
    return widget;
  }

  // --------------------------NET START--------------------------
  bodyText2Response = async (webview, cacheKey) => {
    const widgetSetting = this.readWidgetSetting();
    const text = await webview.evaluateJavaScript("document.body.innerText");
    const ck = await webview.evaluateJavaScript("document.cookie");
    console.log(`CK:${ck} `);
    let RES;
    try {
      this.success = true;
      RES = JSON.parse(text);
      widgetSetting['loginRes'] = 'login';
      this.useFileManager().writeJSONCache(cacheKey, RES);
    } catch (error) {
      this.success = false;
      widgetSetting['loginRes'] = '';
      console.error(`Âä†ËΩΩÂá∫ÈîôÔºö${text} `);
    }
    this.writeWidgetSetting(widgetSetting);
    return RES;
  }

  /**
   * Âä†ËΩΩË¥¶Êà∑‰ΩôÈ¢ù
   */
  loadMoneyBalance = async () => {
    const response = await this.httpGet(
      this.defaultPreference.fetchUrl.balance,
      {
        useCache: this.reset ?? false,
        dataSuccess: (res) => res.serviceResultCode == '0',
        headers: {
          'cookie': this.cookie
        }
      }
    );
    this.fee.balance = response == undefined || response['serviceResultCode'] == 0 ? parseFloat(parseInt(response?.totalBalanceAvailable || 0) / 100).toFixed(2) : 'NAN';
  }

  /**
   * ÊµÅÈáèÊ†ºÂºèÂåñ
   * @param {*} flow 
   * @returns 
   */
  formatFlow = (flow) => {
    const remain = flow / 1024;
    if (remain < 1024) {
      return { amount: remain.toFixed(2), unit: 'MB' };
    }
    return { amount: (remain / 1024).toFixed(2), unit: 'GB' };
  }

  /**
   * Âä†ËΩΩÊòéÁªÜ
   * @returns 
   */
  loadDetailInfo = async (widgetSetting) => {
    const { filterOrientateFlow, showUsedFlow } = widgetSetting;
    const response = await this.httpGet(
      this.defaultPreference.fetchUrl.detail,
      {
        useCache: this.reset ?? false,
        dataSuccess: (res) => res.paraFieldResult == 'SUCCESS',
        headers: {
          'cookie': this.cookie
        }
      }
    );
    // ÊÄªÊµÅÈáè
    let totalFlowAmount = 0;
    // Ââ©‰ΩôÊµÅÈáè
    let totalBalanceFlowAmount = 0;
    // Â∑≤Áî®ÊµÅÈáè
    let totalUsedFlowAmount = 0;
    // ÊÄªËØ≠Èü≥
    let totalVoiceAmount = 0;
    // Ââ©‰ΩôËØ≠Èü≥
    let totalBalanceVoiceAmount = 0;
    // ËØ≠Èü≥
    if (response?.voiceAmount && response?.voiceBalance) {
      totalVoiceAmount = response.voiceAmount;
      totalBalanceVoiceAmount = response.voiceBalance;
    }
    // ÊµÅÈáè&ËØ≠Èü≥
    response?.items?.forEach((data) => {
      if (data.offerType !== 19) {
        data.items?.forEach((item) => {
          if (item.unitTypeId == 3) {
            if (!(item.usageAmount == 0 && item.balanceAmount == 0)) {
              let ratableResourcename = item.ratableResourcename;
              let ratableAmount = item.ratableAmount;
              let balanceAmount = item.balanceAmount;
              let usedAmount = ratableAmount - balanceAmount;
              console.log(`Â•óÈ§êÂêçÁß∞Ôºö¬´${ratableResourcename}¬ª`);
              console.log(`Â•óÈ§êÊÄªÊµÅÈáèÔºö${ratableAmount} MB`);
              console.log(`Â•óÈ§êÂâ©‰ΩôÊµÅÈáèÔºö${balanceAmount} MB`);
              console.log(`Â•óÈ§êÂ∑≤Áî®ÊµÅÈáèÔºö${usedAmount} MB`);
              console.log(`================================= `);
              if (filterOrientateFlow && ratableResourcename.search('ÂÆöÂêë') != -1 || balanceAmount == '999999999999') {
                ratableAmount = 0;
                balanceAmount = 0;
              }
              totalFlowAmount += parseFloat(ratableAmount);
              totalBalanceFlowAmount += parseFloat(balanceAmount);
              totalUsedFlowAmount += parseFloat(usedAmount);
            }
            if (showUsedFlow) {
              this.flow.title = '‚õΩÔ∏è ÊµÅÈáèÂ∑≤Áî®Ôºö';
            }
            if (data.offerType == 21 && item.ratableAmount == '0') {
              // Êó†ÈôêÊµÅÈáèÁî®Êà∑
              const usageAmountObj = this.formatFlow(item.usageAmount);
              this.flow.title = '‚õΩÔ∏è ÊµÅÈáèÂ∑≤Áî®Ôºö';
              this.flow.balance = usageAmountObj.amount;
              this.flow.unit = usageAmountObj.unit;
            }
          } else if (!response.voiceBalance && item.unitTypeId == 1) {
            totalVoiceAmount += parseInt(item.ratableAmount);
            totalBalanceVoiceAmount += parseInt(item.balanceAmount);
          }
        });
      }
    });
    const totalFlowObj = this.formatFlow(totalFlowAmount);
    const totalBalanceFlowObj = this.formatFlow(totalBalanceFlowAmount);
    const totalUsedFlowObj = this.formatFlow(totalUsedFlowAmount);
    const finalBalanceFlowObj = showUsedFlow ? totalUsedFlowObj : totalBalanceFlowObj;
    console.log(`ÊÄªÊµÅÈáèÔºö${totalFlowObj.amount}${totalFlowObj.unit} `);
    console.log(`Ââ©‰ΩôÊµÅÈáèÔºö${totalBalanceFlowObj.amount}${totalBalanceFlowObj.unit} `);
    console.log(`Â∑≤‰ΩøÁî®ÊµÅÈáèÔºö${totalUsedFlowObj.amount}${totalUsedFlowObj.unit} `);
    console.log(`ÊÄªËØ≠Èü≥Ôºö${totalVoiceAmount}${this.voice.unit} `);
    console.log(`Ââ©‰ΩôËØ≠Èü≥Ôºö${totalBalanceVoiceAmount}${this.voice.unit} `);
    console.log(`================================= `);
    // ËÆæÁΩÆÊµÅÈáè
    this.flow.percent = ((totalBalanceFlowAmount / (totalFlowAmount || 1)) * 100).toFixed(2);
    this.flow.balance = finalBalanceFlowObj.amount;
    this.flow.unit = finalBalanceFlowObj.unit;
    // ËÆæÁΩÆËØ≠Èü≥
    this.voice.percent = ((totalBalanceVoiceAmount / (totalVoiceAmount || 1)) * 100).toFixed(2);
    this.voice.balance = totalBalanceVoiceAmount;
  }

  // --------------------------NET END--------------------------
}

await new Widget(Script.name()).run();


// =================================================================================
// =================================================================================
async function downloadLSPDependency() {
  let fm = FileManager.local();
  const fileName = fm.joinPath(fm.documentsDirectory(), `LSP/${Script.name()}/settings.json`);
  const fileExists = fm.fileExists(fileName);
  let cacheString = '{}';
  if (fileExists) {
    cacheString = fm.readString(fileName);
  }
  const use_github = JSON.parse(cacheString)['use_github'];
  const dependencyURL = `${use_github ? remoteGithubRoot : remoteHomeLandRoot}/_LSP.js`;
  const update = needUpdateDependency();
  if (isDev) {
    const iCloudPath = FileManager.iCloud().documentsDirectory();
    const localIcloudDependencyExit = fm.isFileStoredIniCloud(`${iCloudPath}/_LSP.js`);
    const localDependencyExit = fm.fileExists(`${rootDir}/_LSP.js`);
    const fileExist = localIcloudDependencyExit || localDependencyExit;
    console.log(`üöÄ DEVÂºÄÂèë‰æùËµñÊñá‰ª∂${fileExist ? 'Â∑≤Â≠òÂú® ‚úÖ' : '‰∏çÂ≠òÂú® üö´'}`);
    if (!fileExist || update) {
      console.log(`ü§ñ DEV ÂºÄÂßã${update ? 'Êõ¥Êñ∞' + dependencyLSP : '‰∏ãËΩΩ'}‰æùËµñ~`);
      keySave('VERSION', dependencyLSP);
      await downloadFile2Scriptable('_LSP', dependencyURL);
    }
    return;
  }

  //////////////////////////////////////////////////////////
  console.log(`----------------------------------------`);
  const remoteDependencyExit = fm.fileExists(`${cacheDir}/_LSP.js`);
  console.log(`üöÄ RELEASE‰æùËµñÊñá‰ª∂${remoteDependencyExit ? 'Â∑≤Â≠òÂú® ‚úÖ' : '‰∏çÂ≠òÂú® üö´'}`);
  // ------------------------------
  if (!remoteDependencyExit || update) { // ‰∏ãËΩΩ‰æùËµñ
    // ÂàõÂª∫Ê†πÁõÆÂΩï
    if (!fm.fileExists(cacheDir)) {
      fm.createDirectory(cacheDir, true);
    }
    // ‰∏ãËΩΩ
    console.log(`ü§ñ RELEASEÂºÄÂßã${update ? 'Êõ¥Êñ∞' : '‰∏ãËΩΩ'}‰æùËµñ~`);
    console.log(`----------------------------------------`);
    const req = new Request(dependencyURL);
    const moduleJs = await req.load();
    if (moduleJs) {
      fm.write(fm.joinPath(cacheDir, '/_LSP.js'), moduleJs);
      keySave('VERSION', dependencyLSP);
      console.log('‚úÖ LSPËøúÁ®ã‰æùËµñÁéØÂ¢É‰∏ãËΩΩÊàêÂäüÔºÅ');
      console.log(`----------------------------------------`);
    } else {
      console.error('üö´ Ëé∑Âèñ‰æùËµñÁéØÂ¢ÉËÑöÊú¨Â§±Ë¥•ÔºåËØ∑ÈáçËØïÔºÅ');
      console.log(`----------------------------------------`);
    }
  }
}

/**
 * Ëé∑Âèñ‰øùÂ≠òÁöÑÊñá‰ª∂Âêç
 * @param {*} fileName 
 * @returns 
 */
function getSaveFileName(fileName) {
  const hasSuffix = fileName.lastIndexOf(".") + 1;
  return !hasSuffix ? `${fileName}.js` : fileName;
};

/**
 * ‰øùÂ≠òÊñá‰ª∂Âà∞ScriptableËΩØ‰ª∂ÁõÆÂΩïÔºåappÂèØÁúãÂà∞
 * @param {*} fileName 
 * @param {*} content 
 * @returns 
 */
function saveFile2Scriptable(fileName, content) {
  try {
    const fm = FileManager.iCloud();
    let fileSimpleName = getSaveFileName(fileName);
    const filePath = fm.joinPath(fm.documentsDirectory(), fileSimpleName);
    fm.writeString(filePath, content);
    return true;
  } catch (error) {
    return false;
  }
};

/**
 * ‰∏ãËΩΩjsÊñá‰ª∂Âà∞ScriptableËΩØ‰ª∂ÁõÆÂΩï
 * @param {*} moduleName ÂêçÁß∞ 
 * @param {*} url Âú®Á∫øÂú∞ÂùÄ 
 * @returns 
 */
async function downloadFile2Scriptable(moduleName, url) {
  const req = new Request(url);
  const content = await req.loadString();
  return saveFile2Scriptable(`${moduleName}`, content);
};

/**
 * ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞‰æùËµñÁâàÊú¨
 */
function needUpdateDependency() {
  return dependencyLSP != keyGet('VERSION');
};

function keySave(cacheKey, cache) {
  if (cache) {
    Keychain.set(Script.name() + cacheKey, cache);
  }
}

function keyGet(cacheKey, defaultValue = '') {
  if (Keychain.contains(Script.name() + cacheKey)) {
    return Keychain.get(Script.name() + cacheKey);
  } else {
    return defaultValue;
  }
}
// =================================================================================
// =================================================================================